---
title: "CPLN 675 Final Project: Urban Growth Modeling"
author: "Sara Mattio and Ilil Feiglin"
date: "5/13/2020"
output: 
  html_document:
    theme: united
    highlight: tango
    toc: true
    toc_float: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r include= FALSE}
library(tidyverse)
library(sf)
library(raster)
library(knitr)
library(kableExtra)
library(tidycensus)
library(tigris)
library(FNN)
library(QuantPsyc)
library(caret)
library(yardstick)
library(pscl)
library(plotROC) 
library(ggrepel)
library(pROC)
library(grid)
library(gridExtra)
library(viridis)
census_api_key("bb77f2a147934164e965121bd02b5cc9e22f3165")
options(tigris_class = "sf", tigris_use_cache = TRUE)
options(yardstick.event_first = FALSE)

mapTheme <- function(base_size = 12) {
  theme(
    text = element_text( color = "black"),
    plot.title = element_text(size = 14,colour = "black"),
    plot.subtitle=element_text(face="italic"),
    plot.caption=element_text(hjust=0),
    axis.ticks = element_blank(),
    panel.background = element_blank(),axis.title = element_blank(),
    axis.text = element_blank(),
    axis.title.x = element_blank(),
    axis.title.y = element_blank(),
    panel.grid.minor = element_blank(),
    panel.border = element_rect(colour = "black", fill=NA, size=2)
  )
}

plotTheme <- function(base_size = 12) {
  theme(
    text = element_text( color = "black"),
    plot.title = element_text(size = 14,colour = "black"),
    plot.subtitle = element_text(face="italic"),
    plot.caption = element_text(hjust=0),
    axis.ticks = element_blank(),
    panel.background = element_blank(),
    panel.grid.major = element_line("grey80", size = 0.1),
    panel.grid.minor = element_blank(),
    panel.border = element_rect(colour = "black", fill=NA, size=2),
    strip.background = element_rect(fill = "grey80", color = "white"),
    strip.text = element_text(size=12),
    axis.title = element_text(size=12),
    axis.text = element_text(size=10),
    plot.background = element_blank(),
    legend.background = element_blank(),
    legend.title = element_text(colour = "black", face = "italic"),
    legend.text = element_text(colour = "black", face = "italic"),
    strip.text.x = element_text(size = 14)
  )
}

palette2 <- c("#41b6c4","#253494")
palette4 <- c("#a1dab4","#41b6c4","#2c7fb8","#253494")
palette5 <- c("#ffffcc","#a1dab4","#41b6c4","#2c7fb8","#253494")
palette10 <- c("#f7fcf0","#e0f3db","#ccebc5","#a8ddb5","#7bccc4",
               "#4eb3d3","#2b8cbe","#0868ac","#084081","#f7fcf0")
```

```{r include=FALSE}

#this function converts a column in to quintiles. It is used for mapping.
quintileBreaks <- function(df,variable) {
  as.character(quantile(df[[variable]],
                        c(.01,.2,.4,.6,.8),na.rm=T))
}

#This function can be used to convert a polygon sf to centroids xy coords.
xyC <- function(aPolygonSF) {
  as.data.frame(
    cbind(x=st_coordinates(st_centroid(aPolygonSF))[,1],
          y=st_coordinates(st_centroid(aPolygonSF))[,2]))
} 

#this function convert a raster to a data frame so it can be plotted in ggplot
rast <- function(inRaster) {
  data.frame(
    xyFromCell(inRaster, 1:ncell(inRaster)), 
    value = getValues(inRaster)) }

```

# Building the Logistic Regression Model 

The local Metropolitan Planning Organization (MPO) has asked us to forecast urban development in 2020. 
Urban growth is a result of multiple variables, such as added population, growing industries that attract new residents, available lands, existing urban patterns, etc. To create a robust model that predicts the probability of a geographic unit, such as a defined cell, to transform, we need to incorporate relevant variables and test for their cumulative impact on the model accuracy.  If the model proves useful (by cross-validation and reviewing the confusion matrix data), It will assist in the region’s next large-scale comprehensive planning process.

## Austin, Texas

Austin, Texas, is the 11th most populated city within the US (as of 2014)^[https://www.infoplease.com/us/us-cities/top-50-cities-us-population-and-rank], and the fourth-largest city within Texas state. It is a growing city, with a positive population change between 2000 and 2010, and with a positive population growth estimation for 2018. We chose Austin as our case study because it combines significant urban growth with available expansion (undeveloped) areas within its MSA counties, as we will review in the land cover section. 

```{r include=FALSE}

options(tigris_class = "sf")

Austin1 <- st_read("C:/Users/ssmat/Desktop/CPLN675/Final_Project/Austin_Reproj.shp")

studyAreaCounties <- 
  counties("Texas") %>%
  st_transform(st_crs(Austin1)) %>%
  dplyr::select(NAME) %>%
  .[st_buffer(Austin1,-2600), , op=st_intersects]
```

```{r echo=FALSE, message = FALSE, warning = FALSE}
ggplot() +
  geom_sf(data=studyAreaCounties) +
  labs(title = "Study area MSA counties") +
  mapTheme()
```

For this purpose, we will use three MSA counties: Williamson, Travis, and Hays (from north to south). 

Before we present our regression model and the two scenarios, we will briefly present each variable we used within the model.

## Variables

### Land Cover

Our regression aims to predict urban growth. Therefore, our dependent variable must be a version of counted or aggregated cells (or pixels) that experienced urban change. 

To create our dependent variable, we first substracted developed areas within 2011 land cover data from 2001 development.  This output was then reclassified to produce a raster that includes only NA and 1's, using both ArcMap and R.

```{r echo=FALSE, message = FALSE, warning = FALSE}

lc_change2 = raster("C:/Users/ssmat/Desktop/CPLN675/Final_Project/chngI.tif")

lc_change2[lc_change2 < 1] <- NA
lc_change2[lc_change2 > 1] <- NA

ggplot() +
  geom_sf(data=Austin1) +
  geom_raster(data=rast(lc_change2) %>% na.omit, 
              aes(x,y,fill=as.factor(value))) +
  scale_fill_viridis(discrete=TRUE, name ="Land Cover\nChange") + 
  labs(title="Development land use change") +
  mapTheme()

```

Observing the plot, it is apparent that these cells are clustered around the existing development while leaving the margins with a relatively low amount of change. This is a typical growth pattern and one we would expect around metropolitan areas. 

We then create a fishnet of 500*500 foot cells and review land cover classifications in the Austin MSA from 2001 data:

```{r echo=FALSE, message = FALSE, warning = FALSE}

AustinMSA_fishnet <- 
  st_make_grid(Austin1, 500) %>%
  st_sf()

AustinMSA_fishnet <-
  AustinMSA_fishnet[Austin1,]

ggplot() +
  geom_sf(data=AustinMSA_fishnet) +
  labs(title="Fishnet, 500 foot resolution") +
  mapTheme()

changePoints <-
  rasterToPoints(lc_change2) %>%
  as.data.frame() %>%
  st_as_sf(coords = c("x", "y"), crs = st_crs(AustinMSA_fishnet))

fishnet <- 
  aggregate(changePoints, AustinMSA_fishnet, sum) %>%
  mutate(lc_change = ifelse(is.na(chngI),0,1),
         lc_change = as.factor(lc_change))

lc_2001 <- raster("C:/Users/ssmat/Desktop/CPLN675/Final_Project/LC2001.tif")

developed <- lc_2001 == 21 | lc_2001 == 22 | lc_2001 == 23 | lc_2001 == 24
forest <- lc_2001 == 41 | lc_2001 == 42 | lc_2001 == 43 
farm <- lc_2001 == 81 | lc_2001 == 82 
wetlands <- lc_2001 == 90 | lc_2001 == 95 
otherUndeveloped <- lc_2001 == 52 | lc_2001 == 71 | lc_2001 == 31 
water <- lc_2001 == 11

names(developed) <- "developed"
names(forest) <- "forest"
names(farm) <- "farm"
names(wetlands) <- "wetlands"
names(otherUndeveloped) <- "otherUndeveloped"
names(water) <- "water"

aggregateRaster <- function(inputRasterList, theFishnet) {
  theseFishnets <- theFishnet %>% dplyr::select()
  for (i in inputRasterList) {
    varName <- names(i)
    thesePoints <-
      rasterToPoints(i) %>%
      as.data.frame() %>%
      st_as_sf(coords = c("x", "y"), crs = st_crs(theFishnet)) %>%
      filter(.[[1]] == 1)
    thisFishnet <-
      aggregate(thesePoints, theFishnet, length) %>%
      mutate(!!varName := ifelse(is.na(.[[1]]),0,1))
    theseFishnets <- cbind(theseFishnets,thisFishnet)
  }
  return(theseFishnets)
}

theRasterList <- c(developed,forest,farm,wetlands,otherUndeveloped,water)

aggregatedRasters <-
  aggregateRaster(theRasterList, AustinMSA_fishnet) %>%
  dplyr::select(developed,forest,farm,wetlands,otherUndeveloped,water) %>%
  mutate_if(is.numeric,as.factor)

aggregatedRasters %>%
  gather(var,value,developed:water) %>%
  st_cast("POLYGON") %>%
  mutate(X = xyC(.)$x,
         Y = xyC(.)$y) %>%
  ggplot() +
  geom_sf(data=Austin1) +
  geom_point(aes(X,Y, colour=as.factor(value))) +
  facet_wrap(~var) +
  scale_colour_manual(values = palette2,
                      labels=c("Other","Land Cover"),
                      name = "") +
  labs(title = "Land cover types, 2001",
       subtitle = "As fishnet centroids") +
  mapTheme()

```

We can see that urban development is clustered at the center, while the northeast part of the MSA is mainly farmland. Much of the western region of the MSA is covered in forest and throughout the entire area we see scattered 'other undeveloped' land cover.

### Population Change

```{r echo=FALSE, message = FALSE, warning = FALSE}

AustinPop00 <- 
  get_decennial(geography = "tract", variables = "P001001", year = 2000,
                state = 48, geometry = TRUE, 
                county=c("Hays","Travis","Williamson")) %>%
  rename(pop_2000 = value) %>%
  st_transform(st_crs(AustinMSA_fishnet))

AustinPop10 <- 
  get_decennial(geography = "tract", variables = "P001001", year = 2010,
                state = 48, geometry = TRUE,
                county=c("Hays","Travis","Williamson")) %>%
  rename(pop_2010 = value) %>%
  st_transform(st_crs(AustinMSA_fishnet)) %>%
  st_buffer(-1)

AustinMSA_fishnet <-
  AustinMSA_fishnet %>%
  rownames_to_column("fishnetID") %>% 
  mutate(fishnetID = as.numeric(fishnetID)) %>%
  dplyr::select(fishnetID)

fishnetPopulation00 <-
  st_interpolate_aw(AustinPop00["pop_2000"],AustinMSA_fishnet, extensive=TRUE) %>%
  as.data.frame(.) %>%
  left_join(AustinMSA_fishnet, ., by=c("fishnetID"='Group.1')) %>% 
  mutate(pop_2000 = replace_na(pop_2000,0)) %>%
  dplyr::select(pop_2000)

fishnetPopulation10 <-
  st_interpolate_aw(AustinPop10["pop_2010"],AustinMSA_fishnet, extensive=TRUE) %>%
  as.data.frame(.) %>%
  left_join(AustinMSA_fishnet, ., by=c("fishnetID"='Group.1')) %>% 
  mutate(pop_2010 = replace_na(pop_2010,0)) %>%
  dplyr::select(pop_2010)

fishnetPopulation <- 
  cbind(fishnetPopulation00,fishnetPopulation10) %>%
  dplyr::select(pop_2000,pop_2010) %>%
  mutate(pop_Change = pop_2010 - pop_2000)

grid.arrange(
  ggplot() +
    geom_sf(data=AustinPop10, aes(fill=factor(ntile(pop_2010,5))),colour=NA) +
    scale_fill_manual(values = palette5,
                      labels=substr(quintileBreaks(AustinPop10,"pop_2010"),1,4),
                      name="Quintile\nBreaks") +
    labs(title="Population, Austin MSA: 2010",
         subtitle="Represented as tracts; Boundaries omitted") +
    mapTheme(),
  
  ggplot() +
    geom_sf(data=fishnetPopulation, aes(fill=factor(ntile(pop_2010,5))),colour=NA) +
    scale_fill_manual(values = palette5,
                      labels=substr(quintileBreaks(fishnetPopulation,"pop_2010"),1,4),
                      name="Quintile\nBreaks") +
    labs(title="Population, Austin MSA: 2010",
         subtitle="Represented as fishnet gridcells; Boundaries omitted") +
    mapTheme(), ncol=2)

```

The quantile maps of population in 2001 and 2011 (based on census data) present a significant change in the outer ring of the city, with almost all parts experiencing some level of population growth. Specifically, we can see that the northeast region expanded and some areas to the east of the city increased significantly. 

### Spatial Lag

```{r echo=FALSE, message = FALSE, warning = FALSE}

#The spatial lag of development

nn_function <- function(measureFrom,measureTo,k) {
  #convert the sf layers to matrices
  measureFrom_Matrix <-
    as.matrix(measureFrom)
  measureTo_Matrix <-
    as.matrix(measureTo)
  nn <-   
    get.knnx(measureTo, measureFrom, k)$nn.dist
  output <-
    as.data.frame(nn) %>%
    rownames_to_column(var = "thisPoint") %>%
    gather(points, point_distance, V1:ncol(.)) %>%
    arrange(as.numeric(thisPoint)) %>%
    group_by(thisPoint) %>%
    summarize(pointDistance = mean(point_distance)) %>%
    arrange(as.numeric(thisPoint)) %>% 
    dplyr::select(-thisPoint) %>%
    pull()
  
  return(output)  
}

fishnet$lagDevelopment <-
  nn_function(xyC(fishnet),
              xyC(filter(aggregatedRasters,developed==1)),
              2)

ggplot() +
  geom_sf(data=Austin1) +
  geom_point(data=fishnet, 
             aes(x=xyC(fishnet)[,1], y=xyC(fishnet)[,2], 
                 colour=factor(ntile(lagDevelopment,5))), size=1.5) +
  scale_colour_manual(values = palette5,
                      labels=substr(quintileBreaks(fishnet,"lagDevelopment"),1,7),
                      name="Quintile\nBreaks") +
  labs(title = "Spatial lag to 2001 development",
       subtitle = "As fishnet centroids") +
  mapTheme()

```

We assume that future development has a higher probability to occur in proximity to the existing urban developed area. Therefore, we create a variable that measures the distance to existing urban land cover and gives higher weights to nearer cells. The result is seen in the above map. 

### Distance to Highways

```{r echo=FALSE, message = FALSE, warning = FALSE}

AustinHighways <-
  read_sf("https://opendata.arcgis.com/datasets/8b2f979d4ef24388a6a893019322e71c_0.geojson") %>%
  st_transform(st_crs(Austin1)) %>%
  st_intersection(Austin1)

emptyRaster <- lc_change2
emptyRaster[] <- NA

highway_raster <- 
  as(AustinHighways,'Spatial') %>%
  rasterize(.,emptyRaster)

highway_raster_distance <- distance(highway_raster)
names(highway_raster_distance) <- "distance_highways"

highwayPoints <-
  rasterToPoints(highway_raster_distance) %>%
  as.data.frame() %>%
  st_as_sf(coords = c("x", "y"), crs = st_crs(AustinMSA_fishnet))

highwayPoints_fishnet <- 
  aggregate(highwayPoints, AustinMSA_fishnet, mean) %>%
  mutate(distance_highways = ifelse(is.na(distance_highways),0,distance_highways))

ggplot() +
  geom_sf(data=Austin1) +
  geom_point(data=highwayPoints_fishnet, aes(x=xyC(highwayPoints_fishnet)[,1], 
                                             y=xyC(highwayPoints_fishnet)[,2], 
                                             colour=factor(ntile(distance_highways,5))),size=1.5) +
  scale_colour_manual(values = palette5,
                      labels=substr(quintileBreaks(highwayPoints_fishnet,"distance_highways"),1,8),
                      name="Quintile\nBreaks") +
  geom_sf(data=AustinHighways, colour = "red") +
  labs(title = "Distance to Highways",
       subtitle = "As fishnet centroids; Highways visualized in red") +
  mapTheme()

```

We can see that the southwestern and northern MSA areas are not in proximity to any highway (and therefore have large segments in dark blue). In general, it seems the city is well-connected, with many areas in yellow and light blue.

## Final Dataset 

Before we build our model, we review the aggregated data to get a better understanding of it and observe potential trends. In the first plot (left), it is clear that new development is more likely to be closely located to highways compared to undeveloped areas. The results of the spatial lag plot (right) are less distinct but it can be observed that new development is located closer to existing development compared to undeveloped areas.  

```{r echo=FALSE, message = FALSE, warning = FALSE}

dat <- 
  cbind(
    fishnet, highwayPoints_fishnet, fishnetPopulation, aggregatedRasters) %>%
  dplyr::select(lc_change, developed, forest, farm, wetlands, otherUndeveloped, water,
                pop_2000, pop_2010, pop_Change, distance_highways,lagDevelopment) %>%
  st_join(studyAreaCounties) %>%
  mutate(developed10 = ifelse(lc_change == 1 & developed == 1, 0, developed)) %>%
  filter(water == 0) 

dat %>%
  dplyr::select(distance_highways,lagDevelopment,lc_change) %>%
  gather(Variable, Value, -lc_change, -geometry) %>%
  ggplot(., aes(lc_change, Value, fill=lc_change)) + 
  geom_bar(position = "dodge", stat = "summary", fun.y = "mean") +
  facet_wrap(~Variable) +
  scale_fill_manual(values = palette2,
                    labels=c("No Change","New Development"),
                    name="") +
  labs(title="New development as a function of the countinuous variables") +
  plotTheme() 
```

The effect of continuous and factor variables on population change are plotted, then grouped by developed and undeveloped (no change) cells. In both cases, we immediately notice a difference. As expected, the population change is visibly higher within cells that were developed.  
``` {r echo=FALSE, message = FALSE, warning = FALSE}
dat %>%
  dplyr::select(pop_2000,pop_2010,pop_Change,lc_change) %>%
  gather(Variable, Value, -lc_change, -geometry) %>%
  ggplot(., aes(lc_change, Value, fill=lc_change)) + 
  geom_bar(position = "dodge", stat = "summary", fun.y = "mean") +
  facet_wrap(~Variable) +
  scale_fill_manual(values = palette2,
                    labels=c("No Change","New Development"),
                    name="") +
  labs(title="New development as a function of factor variables") +
  plotTheme()
```


# Predicting Change

We now build and refine our model and test it:

```{r echo=FALSE, message = FALSE, warning = FALSE}

set.seed(3456)
trainIndex <- 
  createDataPartition(dat$developed, p = .50,
                      list = FALSE,
                      times = 1)
datTrain <- dat[ trainIndex,]
datTest  <- dat[-trainIndex,]

Model1 <- glm(lc_change ~ wetlands + forest  + farm + otherUndeveloped, 
              family="binomial"(link="logit"), data = datTrain)

Model2 <- glm(lc_change ~ wetlands + forest  + farm + otherUndeveloped + lagDevelopment, 
              family="binomial"(link="logit"), data = datTrain)

Model3 <- glm(lc_change ~ wetlands + forest  + farm + otherUndeveloped + lagDevelopment + pop_2000, 
              family="binomial"(link="logit"), data = datTrain)          

Model4 <- glm(lc_change ~ wetlands + forest  + farm + otherUndeveloped + lagDevelopment + pop_2000 + 
                pop_2010, 
              family="binomial"(link="logit"), data = datTrain)              

Model5 <- glm(lc_change ~ wetlands + forest  + farm + otherUndeveloped + lagDevelopment + pop_Change, 
              family="binomial"(link="logit"), data = datTrain)              

Model6 <- glm(lc_change ~ wetlands + forest  + farm + otherUndeveloped + lagDevelopment + pop_Change + 
                distance_highways, 
              family="binomial"(link="logit"), data = datTrain) 

Model7 <- glm(lc_change ~ wetlands + forest  + farm + otherUndeveloped + lagDevelopment + pop_2000 + 
                pop_2010 +  
                distance_highways, 
              family="binomial"(link="logit"), data = datTrain) 

summary(Model7)


modelList <- paste0("Model", 1:7)
map_dfc(modelList, function(x)pR2(get(x)))[4,] %>%
  setNames(paste0("Model",1:7)) %>%
  gather(Model,McFadden) %>%
  ggplot(aes(Model,McFadden)) +
  geom_bar(stat="identity") +
  labs(title= "McFadden R-Squared by Model") +
  plotTheme()
```

We first created six models and in each, we added a variable. This method allows us to review the impact of each additional variable when compare the R-squared values of the models. Evaluating those models, we saw a slight drop in "goodness of fit" from models 4 to 5. We then built an additional 7th model using the population data (as in model 4) and the highways variable. It resulted in the best fit and highest R-squared value, as seen in the chart.   

The plot below shows the predicted probabilities based on Model 7 when using a .5 (50%) threshold. We see that only a small number of predicted probabilities for development change are greater than or equal to 50%. 

```{r echo=FALSE, message = FALSE, warning = FALSE}

testSetProbs <- 
  data.frame(class = datTest$lc_change,
             probs = predict(Model7, datTest, type="response")) 

ggplot(testSetProbs, aes(probs)) +
  geom_density(aes(fill=class), alpha=0.5) +
  scale_fill_manual(values = palette2,
                    labels=c("No Change","New Development")) +
  labs(title = "Histogram of test set predicted probabilities",
       x="Predicted Probabilities",y="Density") +
  plotTheme()

```

At the next stage of reviewing our model with a confusion matrix, a smaller development classification threshold is employed.

```{r echo=FALSE, message = FALSE, warning = FALSE}

# testing accuracy
options(yardstick.event_first = FALSE)

testSetProbs <- 
  testSetProbs %>% 
  mutate(predClass_05 = as.factor(ifelse(testSetProbs$probs >= 0.05 ,1,0)),
         predClass_17 = as.factor(ifelse(testSetProbs$probs >= 0.17 ,1,0))) 

testSetProbs %>%
  dplyr::select(-probs) %>%
  gather(Variable, Value, -class) %>%
  group_by(Variable) %>%
  summarize(Sensitivity = round(yardstick::sens_vec(class,factor(Value)),2),
            Specificity = round(yardstick::spec_vec(class,factor(Value)),2),
            Accuracy = round(yardstick::accuracy_vec(class,factor(Value)),2)) %>% 
  kable() %>%
  kable_styling(full_width = F)
```

``` {r echo=FALSE, message = FALSE, warning = FALSE, fig.width = 9}
predsForMap <-         
  dat %>%
  mutate(probs = predict(Model7, dat, type="response") ,
         Threshold_5_Pct = as.factor(ifelse(probs >= 0.05 ,1,0)),
         Threshold_17_Pct =  as.factor(ifelse(probs >= 0.17 ,1,0))) %>%
  dplyr::select(lc_change,Threshold_5_Pct,Threshold_17_Pct) %>%
  gather(Variable,Value, -geometry) %>%
  st_cast("POLYGON")

ggplot() +
  geom_point(data=predsForMap, aes(x=xyC(predsForMap)[,1], y=xyC(predsForMap)[,2], colour=Value)) +
  facet_wrap(~Variable) +
  scale_colour_manual(values = palette2, labels=c("No Change","New Development"),
                      name="") +
  labs(title="Development Predictions - Low Threshold") + mapTheme()
```

After testing two thresholds (5% and 17%) and their respective sensitivity, specificity, and accuracy values (above chart), we utilize the higher threshold for our confusion matrix. In this specific case, we prefer to have a model that is less precise but generally predicts where new development can happen. As seen in the plot, we receive more negative values (with a higher true-negative rate) using the 17% threshold. 

```{r echo=FALSE, message = FALSE, warning = FALSE}

ConfusionMatrix.metrics <-
  dat %>%
  mutate(probs = predict(Model7, dat, type="response") ,
         Threshold_5_Pct = as.factor(ifelse(probs >= 0.05 ,1,0)),
         Threshold_17_Pct =  as.factor(ifelse(probs >= 0.17 ,1,0))) %>%
  mutate(TrueP_05 = ifelse(lc_change  == 1 & Threshold_5_Pct == 1, 1,0),
         TrueN_05 = ifelse(lc_change  == 0 & Threshold_5_Pct == 0, 1,0),
         TrueP_17 = ifelse(lc_change  == 1 & Threshold_17_Pct == 1, 1,0),
         TrueN_17 = ifelse(lc_change  == 0 & Threshold_17_Pct == 0, 1,0)) %>%
  dplyr::select(., starts_with("True")) %>%
  gather(Variable, Value, -geometry) %>%
  st_cast("POLYGON") 

ggplot(data=ConfusionMatrix.metrics) +
  geom_point(aes(x=xyC(ConfusionMatrix.metrics)[,1], 
                 y=xyC(ConfusionMatrix.metrics)[,2], colour = as.factor(Value))) +
  facet_wrap(~Variable) +
  scale_colour_manual(values = palette2, labels=c("Correct","Incorrect"),
                      name="") +
  labs(title="Development predictions - Low threshold") + mapTheme()

```


## 1. Demand-Side Change

In this scenario, we approximate 2020 Population Projections for Austin, distribute the ‘new’ population among census tracts in the region, and predict where new development will occur in 2020. 

The first stage is predicting population for the three MSA counties.

```{r echo=FALSE, message = FALSE, warning = FALSE}

dat <-
  dat %>%
  mutate(lagDevelopment = nn_function(xyC(.), xyC(filter(.,developed10 == 1)),2))

countyPopulation_2020 <- 
  data.frame(
    NAME = 
      c("Travis","Hays","Williamson"),
    county_projection_2020 = 
      c(1277007,246119,633783)) %>%
  left_join(
    dat %>%
      st_set_geometry(NULL) %>%
      group_by(NAME) %>%
      summarize(county_population_2010 = round(sum(pop_2010))))
```

``` {r echo=FALSE, message = FALSE, warning = FALSE}
countyPopulation_2020 %>%
  gather(Variable,Value, -NAME) %>%
  ggplot(aes(reorder(NAME,-Value),Value)) +
  geom_bar(aes(fill=Variable), stat = "identity") +
  scale_fill_manual(values = palette2,
                    labels=c("2020","2010"),
                    name="Population") +
  labs(title="Population Change by county: 2010 - 2020",
       x="County", y="Population") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  plotTheme()

```

We create a new data frame which includes 2010 population counts and 2020 projections for each county. We can see that Travis county (that includes Austin's center) has the higest projection, with Williamson and Hays following. Hays county contains higher forest cover which may result in the diversion of growth to Williamson or Travis Counties.

After assessing 2020 population, we can predict development demand.

### Demand Prediction

We can see that the highest prediction quantile (dark blue) is around highways. In general, the higher quantiles are within Travis and Williamson counties.

```{r echo=FALSE, message = FALSE, warning = FALSE}

# Predicting development demand
dat_infill <-
  dat %>%
  left_join(countyPopulation_2020) %>%
  mutate(proportion_of_county_pop = pop_2010 / county_population_2010,
         pop_2020.infill = proportion_of_county_pop * county_projection_2020,
         pop_Change = round(pop_2020.infill - pop_2010),2) %>%
  dplyr::select(-county_projection_2020, -county_population_2010, 
                -proportion_of_county_pop, -pop_2020.infill) %>%
  mutate(predict_2020.infill = predict(Model7,. , type="response"))

dat_infill %>%
  ggplot() +  
  geom_point(aes(x=xyC(dat_infill)[,1], y=xyC(dat_infill)[,2], colour = factor(ntile(predict_2020.infill,5)))) +
  scale_colour_manual(values = palette5,
                      labels=substr(quintileBreaks(dat_infill,"predict_2020.infill"),1,4),
                      name="Quintile\nBreaks") +
  geom_sf(data=studyAreaCounties, fill=NA, colour="black", size=1.5) +
  labs(title= "Development Demand in 2020: Predicted Probabilities") +
  mapTheme()

```


### Allocation

In this step, we try to estimate and recommend where new development can and should be allocated, We review sensitive land cover, the destruction that already occured in the last decade, and demand/availabilty parameters of each county to do so. Observing the change from 2001 to 2011, we see areas where forest or wetland was lost (first map). We then plot land cover with continuous use of either forest or wetland as of 2011, resulting in a map of sensitive regions in the area (second map). The resulting distribution of sensitive regions in the map can be explained by similar patterns of clustered forest land cover from 2001 and 2011 Land Cover data.

```{r echo=FALSE, message = FALSE, warning = FALSE}

# 2011 land cover data
lc_2011 <- raster("C:/Users/ssmat/Desktop/CPLN675/Final_Project/LC2011.tif")

developed11 <- lc_2011 == 21 | lc_2011 == 22 | lc_2011 == 23 | lc_2011 == 24
forest11 <- lc_2011 == 41 | lc_2011 == 42 | lc_2011 == 43 
farm11 <- lc_2011 == 81 | lc_2011 == 82 
wetlands11 <- lc_2011 == 90 | lc_2011 == 95 
otherUndeveloped11 <- lc_2011 == 52 | lc_2011 == 71 | lc_2011 == 31 
water11 <- lc_2011 == 11

names(developed11) <- "developed11"
names(forest11) <- "forest11"
names(farm11) <- "farm11"
names(wetlands11) <- "wetlands11"
names(otherUndeveloped11) <- "otherUndeveloped11"
names(water11) <- "water11"

theRasterList11 <- c(developed11,forest11,farm11,wetlands11,otherUndeveloped11,water11)

dat2 <-
  aggregateRaster(theRasterList11, dat) %>%
  dplyr::select(developed11,forest11,farm11,wetlands11,otherUndeveloped11,water11) %>%
  st_set_geometry(NULL) %>%
  bind_cols(.,dat) %>%
  st_sf() %>%
  st_cast("POLYGON")

# create sensitive land lost indicator
dat2 <-
  dat2 %>%
  mutate(sensitive_lost11 = ifelse(forest == 1 & forest11 == 0 |
                                     wetlands == 1 & wetlands11 == 0,1,0))

ggplot() +
  geom_point(data=dat2, aes(x=xyC(dat2)[,1], y=xyC(dat2)[,2], colour=as.factor(sensitive_lost11))) +
  scale_colour_manual(values = palette2,
                      labels=c("No Change","Sensitive Lost"),
                      name = "") +
  labs(title = "Sensitive lands lost: 2001 - 2011",
       subtitle = "As fishnet centroids") +
  mapTheme()

sensitiveRegions <- 
  clump(wetlands11 + forest11) %>%
  rasterToPolygons() %>%
  st_as_sf() %>%
  group_by(clumps) %>% summarize() %>%
  mutate(Acres = as.numeric(st_area(.) * 0.0000229568)) %>%
  filter(Acres > 3954)  %>%
  dplyr::select() %>%
  rasterize(.,emptyRaster) 
sensitiveRegions[sensitiveRegions > 0] <- 1  
names(sensitiveRegions) <- "sensitiveRegions"

dat2 <-
  aggregateRaster(c(sensitiveRegions), dat2) %>%
  dplyr::select(sensitiveRegions) %>%
  st_set_geometry(NULL) %>%
  bind_cols(.,dat2) %>%
  st_sf()

ggplot() +
  geom_point(data=dat2, aes(x=xyC(dat2)[,1], y=xyC(dat2)[,2], colour=as.factor(sensitiveRegions))) +
  scale_colour_manual(values = palette2,
                      labels=c("Other","Sensitive Regions"),
                      name="") +
  labs(title = "Sensitive regions",
       subtitle = "Continous areas of either wetlands or forests greater than 1 acre") +
  mapTheme()

```

Finally, several key indicators are plotted by county. The allocation chart allows us to navigate future development needs and restrictions. All three counties have some development demand (although Hays is the lowest), and all three have significant undeveloped areas. However, Hays County exhibit high levels of sensitive areas and, coupled with low demand, is the least suitable for future development. 

```{r echo=FALSE, message = FALSE, warning = FALSE}
# summarize by county
county_specific_metrics <- 
  dat2 %>%
  mutate(Development_Demand = predict(Model7, dat2, type="response")) %>%
  left_join(st_set_geometry(dat, NULL) %>% group_by(NAME) %>% summarize(count = n())) %>%
  group_by(NAME) %>%
  summarize(Total_Farmland = sum(farm11) / max(count),
            Total_Forest = sum(forest11) / max(count),
            Total_Wetlands = sum(wetlands11) / max(count),
            Total_Undeveloped = sum(otherUndeveloped11) / max(count),
            Sensitive_Land_Lost = sum(sensitive_lost11) / max(count),
            Sensitive_Regions = sum(sensitiveRegions) / max(count),
            Mean_Development_Demand = mean(Development_Demand)) %>%
  left_join(countyPopulation_2020 %>% 
              mutate(Population_Change = county_projection_2020 - county_population_2010,
                     Population_Change_Rate = Population_Change / county_projection_2020) %>%
              dplyr::select(NAME,Population_Change_Rate))

# plot for county specific allocation
county_specific_metrics %>%
  gather(Variable, Value, -NAME, -geometry) %>% filter(!is.na(NAME)) %>%
  mutate(Variable = factor(Variable, levels=c("Population_Change_Rate","Mean_Development_Demand",
                                              "Total_Farmland","Total_Undeveloped","Total_Forest",
                                              "Total_Wetlands","Sensitive_Land_Lost","Sensitive_Regions",
                                              ordered = TRUE))) %>%
  mutate(Planning_Designation = case_when(
    Variable == "Population_Change_Rate" | Variable == "Mean_Development_Demand" ~ "Demand-Side",
    Variable == "Total_Farmland" | Variable == "Total_Undeveloped"               ~ "Suitable",
    TRUE                                                                         ~ "Not Suitable")) %>%
  ggplot(aes(x=Variable, y=Value, fill=Planning_Designation)) +
  geom_bar(stat="identity", position=position_dodge(), colour="black") +
  facet_wrap(~NAME, ncol=5) +
  coord_flip() +
  scale_y_continuous(breaks = seq(.25, 1, by = .25)) +
  geom_vline(xintercept = 2.5) + geom_vline(xintercept = 4.5) +
  scale_fill_manual(values=c("black","red","darkgreen")) +
  labs(title= "County Specific Allocation Metrics", subtitle= "As rates", x="Indicator", y="Rate") +
  plotTheme() + theme(axis.text.x = element_text(angle = 45, hjust = 1), legend.position="bottom")
```


We will now map some of these variables for each county to understand the spatial opportunities and restraints better:

```{r echo=FALSE, message = FALSE, warning = FALSE}
Hays <-
  dat2 %>%
  mutate(Development_Demand = predict(Model7, dat2, type="response")) %>%
  filter(NAME == "Hays") 

Hays_landUse <- rbind(
  filter(Hays, forest11 == 1 | wetlands11 == 1 ) %>%
    dplyr::select() %>% mutate(Land_Use = "Not Suitable"),
  filter(Hays, developed11 == 1) %>%
    dplyr::select() %>% mutate(Land_Use = "Developed"))

grid.arrange(
  ggplot() +
    geom_sf(data=Hays, aes(fill=factor(ntile(Development_Demand,5))), colour=NA) +
      scale_fill_manual(values = palette5, name="Development\nDemand",
                      labels=substr(quintileBreaks(Hays,"Development_Demand"),1,5)) +
    scale_colour_manual(values = c("black","red")) + 
    labs(title = "Development Potential,\n 2020: Hays") + mapTheme() +
    guides(fill = guide_legend(order = 1), colour = guide_legend(order = 2)),
  
  ggplot() +
    geom_sf(data=Hays, aes(fill=factor(ntile(pop_Change,5))), colour=NA) +
    scale_fill_manual(values = palette5, name="Population\nChange",
                      labels=substr(quintileBreaks(Hays,"pop_Change"),1,5)) +
    scale_colour_manual(values = c("black","red")) + 
    labs(title = "Projected Population,\n 2020: Hays") + mapTheme() +
    guides(fill = guide_legend(order = 1), colour = guide_legend(order = 2)),ncol=2)
```

``` {r echo=FALSE, message = FALSE, warning = FALSE}
ggplot() +
    geom_sf(data=Hays, aes(fill=factor(ntile(Development_Demand,5))), colour=NA) +
    geom_point(data=Hays_landUse, aes(x=xyC(Hays_landUse)[,1], 
                                          y=xyC(Hays_landUse)[,2], colour=Land_Use),
               shape = 15, size = 2) +
    geom_sf(data=st_intersection(AustinHighways,filter(studyAreaCounties, NAME=="Hays")), size=2) +
    scale_fill_manual(values = palette5, name="Development\nDemand",
                      labels=substr(quintileBreaks(Hays,"Development_Demand"),1,5)) +
    scale_colour_manual(values = c("black","red")) + 
    labs(title = "Development Potential, 2020: Hays") + mapTheme() +
    guides(fill = guide_legend(order = 1), colour = guide_legend(order = 2))

```

We can observe that the majority of Hays County is not suitable for development with the exception of the northeastern section, where high values of projected population are exhibited.

```{r echo=FALSE, message = FALSE, warning = FALSE}
Travis <-
  dat2 %>%
  mutate(Development_Demand = predict(Model7, dat2, type="response")) %>%
  filter(NAME == "Travis") 

Travis_landUse <- rbind(
  filter(Travis, forest11 == 1 | wetlands11 == 1 ) %>%
    dplyr::select() %>% mutate(Land_Use = "Not Suitable"),
  filter(Travis, developed11 == 1) %>%
    dplyr::select() %>% mutate(Land_Use = "Developed"))

grid.arrange(
  ggplot() +
    geom_sf(data=Travis, aes(fill=factor(ntile(Development_Demand,5))), colour=NA) +
      scale_fill_manual(values = palette5, name="Development\nDemand",
                      labels=substr(quintileBreaks(Travis,"Development_Demand"),1,5)) +
    scale_colour_manual(values = c("black","red")) + 
    labs(title = "Development Potential,\n 2020: Travis") + mapTheme() +
    guides(fill = guide_legend(order = 1), colour = guide_legend(order = 2)),
  
  ggplot() +
    geom_sf(data=Travis, aes(fill=factor(ntile(pop_Change,5))), colour=NA) +
    scale_fill_manual(values = palette5, name="Population\nChange",
                      labels=substr(quintileBreaks(Travis,"pop_Change"),1,5)) +
    scale_colour_manual(values = c("black","red")) + 
    labs(title = "Projected Population,\n 2020: Travis") + mapTheme() +
    guides(fill = guide_legend(order = 1), colour = guide_legend(order = 2)),ncol=2)

ggplot() +
    geom_sf(data=Travis, aes(fill=factor(ntile(Development_Demand,5))), colour=NA) +
    geom_point(data=Travis_landUse, aes(x=xyC(Travis_landUse)[,1], 
                                          y=xyC(Travis_landUse)[,2], colour=Land_Use),
               shape = 15, size = 2) +
    geom_sf(data=st_intersection(AustinHighways,filter(studyAreaCounties, NAME=="Travis")), size=2) +
    scale_fill_manual(values = palette5, name="Development\nDemand",
                      labels=substr(quintileBreaks(Travis,"Development_Demand"),1,5)) +
    scale_colour_manual(values = c("black","red")) + 
    labs(title = "Development Potential, 2020: Travis") + mapTheme() +
    guides(fill = guide_legend(order = 1), colour = guide_legend(order = 2))

```

Travis county, where much of Austin's development is contained, is largely developed around its center, with possible development potential (one that is uncovered by either black or red cells) in its northeastern region. This is a partial image because cities can use infill and densification tactics to increase population within already developed land cover. 

```{r echo=FALSE, message = FALSE, warning = FALSE}

Williamson <-
  dat2 %>%
  mutate(Development_Demand = predict(Model7, dat2, type="response")) %>%
  filter(NAME == "Williamson") 

Williamson_landUse <- rbind(
  filter(Williamson, forest11 == 1 | wetlands11 == 1 ) %>%
    dplyr::select() %>% mutate(Land_Use = "Not Suitable"),
  filter(Williamson, developed11 == 1) %>%
    dplyr::select() %>% mutate(Land_Use = "Developed"))

grid.arrange(
  ggplot() +
    geom_sf(data=Williamson, aes(fill=factor(ntile(Development_Demand,5))), colour=NA) +
      scale_fill_manual(values = palette5, name="Development\nDemand",
                      labels=substr(quintileBreaks(Williamson,"Development_Demand"),1,5)) +
    scale_colour_manual(values = c("black","red")) + 
    labs(title = "Development Potential,\n 2020: Williamson") + mapTheme() +
    guides(fill = guide_legend(order = 1), colour = guide_legend(order = 2)),
  
  ggplot() +
    geom_sf(data=Williamson, aes(fill=factor(ntile(pop_Change,5))), colour=NA) +
    scale_fill_manual(values = palette5, name="Population\nChange",
                      labels=substr(quintileBreaks(Travis,"pop_Change"),1,5)) +
    scale_colour_manual(values = c("black","red")) + 
    labs(title = "Projected Population,\n 2020: Williamson") + mapTheme() +
    guides(fill = guide_legend(order = 1), colour = guide_legend(order = 2)),ncol=2)
```

```{r echo=FALSE, message = FALSE, warning = FALSE}
ggplot() +
    geom_sf(data=Williamson, aes(fill=factor(ntile(Development_Demand,5))), colour=NA) +
    geom_point(data=Williamson_landUse, aes(x=xyC(Williamson_landUse)[,1], 
                                          y=xyC(Williamson_landUse)[,2], colour=Land_Use),
               shape = 15, size = 2) +
    geom_sf(data=st_intersection(AustinHighways,filter(studyAreaCounties, NAME=="Williamson")), size=2) +
    scale_fill_manual(values = palette5, name="Development\nDemand",
                      labels=substr(quintileBreaks(Williamson,"Development_Demand"),1,5)) +
    scale_colour_manual(values = c("black","red")) + 
    labs(title = "Development Potential, 2020: Williamson") + mapTheme() +
    guides(fill = guide_legend(order = 1), colour = guide_legend(order = 2))

```

Lastly, the northern county exhibit the highest uncovered areas, with potential for growth in its eastern part. 

The three counties exhibit varying levels of land sensitivity. These maps increase our general understanding of possible growth areas but do not consider infill, densification, or the potential destruction of sensitive land (if approved by the municipality). It should be regarded as a general allocation direction and not taken as is. With the additional insight provided by the maps, we can state that we suggest development in the upper eastern part of Austin's MSA. 

## 2.	Supply-Side Change

After reviewing demand projections, we then test projections based on an imagined Highway Expansion Project. We propose two highways extensions (seen in the below maps in red): one within Travis county and one in Williamson. The proposed extensions will allow urban growth further from the city center. As seen in previous maps, those areas do not contain many sensitive cells (red cells).

We first added the new roads into our dataset, then tested the regression model previously used (Model 7) with the new data. We created a population forecast and plotted the probability to review the change from our first model.


``` {r include=FALSE}

AustinHighways_new <- st_read("C:/Users/ssmat/Desktop/CPLN675/Final_Project/newH.shp") %>%
  st_transform(st_crs(Austin1)) %>%
  st_intersection(Austin1)

changed <- AustinHighways_new %>%
  filter(FID_1 == 0)
```

``` {r echo=FALSE, message = FALSE, warning = FALSE}
grid.arrange(ggplot() +
  geom_sf(data=Austin1) +
  geom_sf(data=AustinHighways,col= "blue") +
  labs(title = "Highways Before Change") +
  mapTheme(), 
  ggplot() +
  geom_sf(data=Austin1) +
  geom_sf(data=AustinHighways_new,col= "blue")+
  geom_sf(data=changed,col= "red")+
  labs(title = "Highways After Addition") +
  mapTheme(),ncol=2)
```

\s\s
As seen above, we added a new highway section within Travis County in high proximity to Williamson's boundary. As discussed before, both Travis and Williamson are believed to be the most suitable for new development, with little to no projected damage to sensitive areas. The new highway will allow for greater connectivity to Austin's center while keeping intact the forest areas that are west to Austin's center. 

### Prediction

After adding the highway to our data, we run our revised model. 

```{r echo=FALSE, message = FALSE, warning = FALSE}

new_highway_raster <- 
  as(AustinHighways_new,'Spatial') %>%
  rasterize(.,emptyRaster)

new_highway_raster_distance <- distance(new_highway_raster)
names(new_highway_raster_distance) <- "distance_highways"

new_highwayPoints <-
  rasterToPoints(new_highway_raster_distance) %>%
  as.data.frame() %>%
  st_as_sf(coords = c("x", "y"), crs = st_crs(AustinMSA_fishnet))

new_highwayPoints_fishnet <- 
  aggregate(new_highwayPoints, AustinMSA_fishnet, mean) %>%
  mutate(distance_highways = ifelse(is.na(distance_highways),0,distance_highways))

newhighways_dat <- 
  cbind(
    fishnet, new_highwayPoints_fishnet, fishnetPopulation, aggregatedRasters) %>%
  dplyr::select(lc_change, developed, forest, farm, wetlands, otherUndeveloped, water,
                pop_2000, pop_2010, pop_Change, distance_highways,lagDevelopment) %>%
  st_join(studyAreaCounties) %>%
  mutate(developed10 = ifelse(lc_change == 1 & developed == 1, 0, developed)) %>%
  filter(water == 0) 

NH_trainIndex <- 
  createDataPartition(newhighways_dat$developed, p = .50,
                      list = FALSE,
                      times = 1)
NH_datTrain <- newhighways_dat[ NH_trainIndex,]
NH_datTest  <- newhighways_dat[-NH_trainIndex,]


Model7_2 <- glm(lc_change ~ wetlands + forest  + farm + otherUndeveloped + lagDevelopment + pop_2000 + 
                pop_2010 +  
                distance_highways, 
              family="binomial"(link="logit"), data = NH_datTrain) 

NH_testSetProbs <- 
  data.frame(class = NH_datTest$lc_change,
             probs = predict(Model7_2, NH_datTest, type="response")) 

NH_testSetProbs <- 
  NH_testSetProbs %>% 
  mutate(predClass_05 = as.factor(ifelse(NH_testSetProbs$probs >= 0.05 ,1,0)),
         predClass_17 = as.factor(ifelse(NH_testSetProbs$probs >= 0.17 ,1,0))) 

NH_predsForMap <-         
  newhighways_dat %>%
  mutate(probs = predict(Model7_2, newhighways_dat, type="response") ,
         Threshold_5_Pct = as.factor(ifelse(probs >= 0.05 ,1,0)),
         Threshold_17_Pct =  as.factor(ifelse(probs >= 0.17 ,1,0))) %>%
  dplyr::select(lc_change,Threshold_5_Pct,Threshold_17_Pct) %>%
  gather(Variable,Value, -geometry) %>%
  st_cast("POLYGON")

NH_ConfusionMatrix.metrics <-
  newhighways_dat %>%
  mutate(probs = predict(Model7_2, newhighways_dat, type="response") ,
         Threshold_5_Pct = as.factor(ifelse(probs >= 0.05 ,1,0)),
         Threshold_17_Pct =  as.factor(ifelse(probs >= 0.17 ,1,0))) %>%
  mutate(TrueP_05 = ifelse(lc_change  == 1 & Threshold_5_Pct == 1, 1,0),
         TrueN_05 = ifelse(lc_change  == 0 & Threshold_5_Pct == 0, 1,0),
         TrueP_17 = ifelse(lc_change  == 1 & Threshold_17_Pct == 1, 1,0),
         TrueN_17 = ifelse(lc_change  == 0 & Threshold_17_Pct == 0, 1,0)) %>%
  dplyr::select(., starts_with("True")) %>%
  gather(Variable, Value, -geometry) %>%
  st_cast("POLYGON") 

newhighways_dat <-
  newhighways_dat %>%
  mutate(lagDevelopment = nn_function(xyC(.), xyC(filter(.,developed10 == 1)),2))

NH_countyPopulation_2020 <- 
  data.frame(
    NAME = 
      c("Travis","Hays","Williamson"),
    NH_county_projection_2020 = 
      c(1277007,246119,633783)) %>%
  left_join(
    newhighways_dat %>%
      st_set_geometry(NULL) %>%
      group_by(NAME) %>%
      summarize(county_population_2010 = round(sum(pop_2010))))

NH_dat_infill <-
  newhighways_dat %>%
  left_join(NH_countyPopulation_2020) %>%
  mutate(proportion_of_county_pop = pop_2010 / county_population_2010,
         pop_2020.infill = proportion_of_county_pop * NH_county_projection_2020,
         pop_Change = round(pop_2020.infill - pop_2010),2) %>%
  dplyr::select(-NH_county_projection_2020, -county_population_2010, 
                -proportion_of_county_pop, -pop_2020.infill) %>%
  mutate(predict_2020.infill = predict(Model7_2,. , type="response"))
```

``` {r echo=FALSE, message = FALSE, warning = FALSE}
grid.arrange(
  dat_infill %>%
  ggplot() +  
  geom_point(aes(x=xyC(dat_infill)[,1], y=xyC(dat_infill)[,2], colour = factor(ntile(predict_2020.infill,5)))) +
  scale_colour_manual(values = palette5,
                      labels=substr(quintileBreaks(dat_infill,"predict_2020.infill"),1,4),
                      name="Quintile\nBreaks") +
  geom_sf(data=studyAreaCounties, fill=NA, colour="black", size=1.5) +
  labs(title= "Development Demand in 2020: \nPredicted Probabilities First scenario") +
  mapTheme(),
  
  NH_dat_infill %>%
  ggplot() +  
  geom_point(aes(x=xyC(NH_dat_infill)[,1], y=xyC(NH_dat_infill)[,2], colour = factor(ntile(predict_2020.infill,5)))) +
  scale_colour_manual(values = palette5,
                      labels=substr(quintileBreaks(NH_dat_infill,"predict_2020.infill"),1,4),
                      name="Quintile\nBreaks") +
  geom_sf(data=studyAreaCounties, fill=NA, colour="black", size=1.5) +
  labs(title= "Development Demand in 2020: \nPredicted Probabilities Second scenario") +
  mapTheme(),
  ncol=2)
```

We can see how the two new highways segments alter the probability of growth of the surrounding areas in comparison to the previous scenario.

Because we are using the same threshold (17%) as before, our confusion matrix is the same.
```{r echo=FALSE, message = FALSE, warning = FALSE}

classProbs2 <- predict(Model7_2, newhighways_dat, type="response")
testProbs2 <- data.frame(obs = newhighways_dat$lc_change,
                        pred = classProbs2)

testProbs2$predClass2  = ifelse(testProbs2$pred > .17 ,1,0)

CM2 <- caret::confusionMatrix(reference = as.factor(testProbs2$obs), 
                             data = as.factor(testProbs2$predClass2), 
                             positive = "1")

CM2$table
```

This matrix indicates that our model is good at predicting the zero's (no change), but fails to predict the actual location of the ones (new development). As discussed before, in this particular case we would like to be generally predict where new development can happen, particularly in light of our proposed highways.

```{r echo=FALSE, message = FALSE, warning = FALSE}

NH_dat2 <-
  aggregateRaster(theRasterList11, newhighways_dat) %>%
  dplyr::select(developed11,forest11,farm11,wetlands11,otherUndeveloped11,water11) %>%
  st_set_geometry(NULL) %>%
  bind_cols(.,dat) %>%
  st_sf() %>%
  st_cast("POLYGON")

NH_dat2 <-
  NH_dat2 %>%
  mutate(sensitive_lost11 = ifelse(forest == 1 & forest11 == 0 |
                                     wetlands == 1 & wetlands11 == 0,1,0))

NH_dat2 <-
  aggregateRaster(c(sensitiveRegions), NH_dat2) %>%
  dplyr::select(sensitiveRegions) %>%
  st_set_geometry(NULL) %>%
  bind_cols(.,NH_dat2) %>%
  st_sf()

NH_county_specific_metrics <- 
  NH_dat2 %>%
  mutate(Development_Demand = predict(Model7_2, NH_dat2, type="response")) %>%
  left_join(st_set_geometry(newhighways_dat, NULL) %>% group_by(NAME) %>% summarize(count = n())) %>%
  group_by(NAME) %>%
  summarize(Total_Farmland = sum(farm11) / max(count),
            Total_Forest = sum(forest11) / max(count),
            Total_Wetlands = sum(wetlands11) / max(count),
            Total_Undeveloped = sum(otherUndeveloped11) / max(count),
            Sensitive_Land_Lost = sum(sensitive_lost11) / max(count),
            Sensitive_Regions = sum(sensitiveRegions) / max(count),
            Mean_Development_Demand = mean(Development_Demand)) %>%
  left_join(NH_countyPopulation_2020 %>% 
              mutate(Population_Change = NH_county_projection_2020 - county_population_2010,
                     Population_Change_Rate = Population_Change / NH_county_projection_2020) %>%
              dplyr::select(NAME,Population_Change_Rate))


```

### Allocation

We review the two counties that have expanded growth due to the highway extension.

```{r echo=FALSE, message = FALSE, warning = FALSE}
# Travis
Travis2 <-
  NH_dat2 %>%
  mutate(Development_Demand = predict(Model7_2, NH_dat2, type="response")) %>%
  filter(NAME == "Travis") 

Travis_landUse2 <- rbind(
  filter(Travis2, forest11 == 1 | wetlands11 == 1 ) %>%
    dplyr::select() %>% mutate(Land_Use = "Not Suitable"),
  filter(Travis2, developed11 == 1) %>%
    dplyr::select() %>% mutate(Land_Use = "Developed"))

ggplot() +
    geom_sf(data=Travis2, aes(fill=factor(ntile(Development_Demand,5))), colour=NA) +
    geom_point(data=Travis_landUse2, aes(x=xyC(Travis_landUse2)[,1], 
                                      y=xyC(Travis_landUse2)[,2], colour=Land_Use),
               shape = 15, size = 2) +
    geom_sf(data=st_intersection(AustinHighways_new,filter(studyAreaCounties, NAME=="Travis")), size=2) +
    scale_fill_manual(values = palette5, name="Development\nDemand",
                      labels=substr(quintileBreaks(Travis2,"Development_Demand"),1,5)) +
    scale_colour_manual(values = c("black","red")) + 
    labs(title = "Development Potential, 2020: Travis") + mapTheme() +
    guides(fill = guide_legend(order = 1), colour = guide_legend(order = 2))

# Williamson
Williamson2 <-
  NH_dat2 %>%
  mutate(Development_Demand = predict(Model7_2, NH_dat2, type="response")) %>%
  filter(NAME == "Williamson") 

Williamson_landUse2 <- rbind(
  filter(Williamson, forest11 == 1 | wetlands11 == 1 ) %>%
    dplyr::select() %>% mutate(Land_Use = "Not Suitable"),
  filter(Williamson, developed11 == 1) %>%
    dplyr::select() %>% mutate(Land_Use = "Developed"))

ggplot() +
    geom_sf(data=Williamson2, aes(fill=factor(ntile(Development_Demand,5))), colour=NA) +
    geom_point(data=Williamson_landUse2, aes(x=xyC(Williamson_landUse2)[,1], 
                                        y=xyC(Williamson_landUse2)[,2], colour=Land_Use),
               shape = 15, size = 2) +
    geom_sf(data=st_intersection(AustinHighways_new,filter(studyAreaCounties, NAME=="Williamson")), size=2) +
    scale_fill_manual(values = palette5, name="Development\nDemand",
                      labels=substr(quintileBreaks(Travis,"Development_Demand"),1,5)) +
    scale_colour_manual(values = c("black","red")) + 
    labs(title = "Development Potential, 2020: Williamson") + mapTheme() +
    guides(fill = guide_legend(order = 1), colour = guide_legend(order = 2))

```
The new segments are shown as black cells while their respective background indicates the increased demand around these new commute patterns.


# Conclusion

Austin is a growing city, with sensitive areas on the west that restrict growth. Despite growth restrictions in these areas, future development needs can be met by expanding the northwest (with the regional agriculture sector paying the price), infill and densification strategies within existing developed land (or a combination of both). 
